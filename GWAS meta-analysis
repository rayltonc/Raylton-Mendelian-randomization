##AWIGen
METAL_AWIGen <- clumped_AWIGenresults %>%
  rename(
    SNP = rsid,
    REF_ALLELE = ref_allele,     
    OTHER_ALLELE = other_allele, 
    BETA = effect_size,
    PVALUE = pval,
    SE = std_error
  ) %>%
  # Calculate Variance and Weight
  mutate(
    N = 10775         # Add sample size column
  )

head (METAL_AWIGen)

#####Save the Data File
write.table(METAL_AWIGen, file = "METAL_AWIGen.txt", 
            sep = "\t", row.names = FALSE, quote = FALSE)

###GIANT
METAL_GIANT <- clumped_results_GIANT %>%
  rename(
    SNP = rsid,
    REF_ALLELE = ref_allele,     
    OTHER_ALLELE = other_allele, 
    BETA = effect_size,
    PVALUE = pval,
    SE = std_error
  ) %>%
  # Calculate Variance and Weight
  mutate(
    N = 681275         # Add sample size column
  )

head (METAL_GIANT)

#####Save the Data File
write.table(METAL_GIANT, file = "METAL_GIANT.txt", 
            sep = "\t", row.names = FALSE, quote = FALSE)

###standardising p-values

# Load datasets
dataset1 <- read.table("METAL_GIANT.txt", header = TRUE)
dataset2 <- read.table("METAL_AWIGen.txt", header = TRUE)

# Convert p-values to scientific notation with consistent formatting
dataset1$PVALUE <- formatC(dataset1$PVALUE, format = "e", digits = 10)
dataset2$PVALUE <- formatC(dataset2$PVALUE, format = "e", digits = 10)

# Save the standardized datasets
write.table(dataset1, "METAL_GIANT_standardized.txt", row.names = FALSE, quote = FALSE)
write.table(dataset2, "METAL_AWIGen_standardized.txt", row.names = FALSE, quote = FALSE)

####Performing meta-analysis between GIANT and AWIGen using METAL######p values and sample size

MARKER SNP
ALLELE REF_ALLELE OTHER_ALLELE
EFFECT EFFECT1
PVALUE PVALUE
WEIGHT N

PROCESS METAL_GIANT.txt
PROCESS METAL_AWIGen.txt

OUTFILE METAANALYSIS_METAL_AWIGen_standardized.txt-METAL_GIANT_standardized.txt_ .tbl
ANALYZE

ANALYZE HETEROGENEITY

## In R Read results
setwd("C:/Users/raylt/Documents/GWAS/generic-metal")

file_path <- "METAANALYSIS_METAL_AWIGen_standardized.txt-METAL_GIANT_standardized.txt_ .tbl"

file_contents <- readLines(file_path)

head(file_contents, n = 10)

# Attempt to read the file as a table (assuming tab-separated values)
info_df <- read.table(file_path, header = TRUE, sep = "\t", stringsAsFactors = FALSE)

# View the data frame structure
str(info_df)

# View the first few rows
head(info_df)

file_contents <- readLines(file_path)

head(file_contents, n = 10)

# Read the file as a table
info_df <- read.table(file_path, header = TRUE, sep = "\t", stringsAsFactors = FALSE)

# View the data frame structure
str(info_df)

# View the first few rows
head(info_df)


# renaming columns
# Trim spaces and then rename Markername and P.value columns
colnames(info_df) <- trimws(colnames(info_df))
colnames(info_df)[colnames(info_df) == 'MarkerName'] <- 'rsid'

colnames(info_df) <- trimws(colnames(info_df))
colnames(info_df)[colnames(info_df) == 'P.value'] <- 'pval'


#LD clumping
clumped_results_info_df <- ld_clump(
  dat = info_df,
  plink_bin = plink_bin_path,
  bfile = bfile_path, pop = "AFR"
)

# Export the data frame to a CSV file
output_file_path <- "METAANALYSIS.LD_SNPS.csv"
write.csv(clumped_results_info_df, file = output_file_path, row.names = FALSE)

##Heterogeneity
file_path2 <- "METAANALYSIS_METAL_AWIGen_standardized.txt-METAL_GIANT_standardized.txt_2.tbl"

file_contents2 <- readLines(file_path2)

head(file_contents2, n = 10)

# Read the file as a table
info_df2 <- read.table(file_path2, header = TRUE, sep = "\t", stringsAsFactors = FALSE)

# View the first few rows
head(info_df2)

# Export the data frame to a CSV file
output_file_path <- "HETEROGENEITY.csv"
write.csv(info_df2, file = output_file_path, row.names = FALSE)


            
